name: Release

on:
    push:
        tags:
            - "*"
    workflow_dispatch:
        inputs:
            version:
                description: "Version to release (e.g., 1.0.0)"
                required: false

permissions:
    contents: write
    actions: write

env:
    PLUGIN_NAME: "obsidian-terminal"

jobs:
    # ===========================================
    # Build native modules for each platform x ABI combination
    # ===========================================
    build-native:
        strategy:
            fail-fast: false
            matrix:
                include:
                    # ===== ABI 140 (Electron 39.x, Obsidian 1.11.x) =====
                    - os: [self-hosted, Windows, X64]
                      platform: win32
                      arch: x64
                      node-version: "24"
                      electron-version: "39.2.6"
                      node-abi: "140"
                    - os: macos-15-intel
                      platform: darwin
                      arch: x64
                      node-version: "24"
                      electron-version: "39.2.6"
                      node-abi: "140"
                    - os: [self-hosted, macOS, ARM64]
                      platform: darwin
                      arch: arm64
                      node-version: "24"
                      electron-version: "39.2.6"
                      node-abi: "140"
                    - os: ubuntu-latest
                      platform: linux
                      arch: x64
                      node-version: "24"
                      electron-version: "39.2.6"
                      node-abi: "140"
                    # ===== ABI 136 (Electron 37.x, Obsidian 1.10.x) =====
                    - os: [self-hosted, Windows, X64]
                      platform: win32
                      arch: x64
                      node-version: "24"
                      electron-version: "37.10.2"
                      node-abi: "136"
                    - os: macos-15-intel
                      platform: darwin
                      arch: x64
                      node-version: "24"
                      electron-version: "37.10.2"
                      node-abi: "136"
                    - os: [self-hosted, macOS, ARM64]
                      platform: darwin
                      arch: arm64
                      node-version: "24"
                      electron-version: "37.10.2"
                      node-abi: "136"
                    - os: ubuntu-latest
                      platform: linux
                      arch: x64
                      node-version: "24"
                      electron-version: "37.10.2"
                      node-abi: "136"

        runs-on: ${{ matrix.os }}
        name: Build ${{ matrix.platform }}-${{ matrix.arch }} (ABI ${{ matrix.node-abi }})

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"

            # Windows: Install without running postinstall scripts to avoid premature node-pty build
            - name: Install dependencies (Windows)
              if: matrix.platform == 'win32'
              run: pnpm install --frozen-lockfile --ignore-scripts

            # Unix: Normal install
            - name: Install dependencies (Unix)
              if: matrix.platform != 'win32'
              run: pnpm install --frozen-lockfile

            # Update node-abi to support latest Electron versions
            - name: Update node-abi for Electron compatibility
              run: pnpm add -D node-abi@latest

            # Windows: Download headers, fix source files, then rebuild
            - name: Download Electron headers (Windows)
              if: matrix.platform == 'win32'
              run: npx @electron/rebuild -m node_modules/node-pty -v ${{ matrix.electron-version }} --force
              continue-on-error: true

            - name: Fix source files (Windows)
              if: matrix.platform == 'win32'
              run: |
                  node scripts/fix-electron-headers.mjs ${{ matrix.electron-version }}
                  node scripts/fix-winpty-cc.mjs
                  node scripts/fix-conpty-cc.mjs

            - name: Rebuild node-pty for Electron (Windows)
              if: matrix.platform == 'win32'
              run: npx @electron/rebuild -m node_modules/node-pty -v ${{ matrix.electron-version }} --force

            # Unix: Just rebuild directly (no header fixes needed)
            - name: Rebuild node-pty for Electron (Unix)
              if: matrix.platform != 'win32'
              run: npx @electron/rebuild -m node_modules/node-pty -v ${{ matrix.electron-version }}

            - name: Copy binaries
              run: node scripts/copy-node-pty-binaries.mjs

            - name: List built binaries (Windows)
              if: matrix.platform == 'win32'
              shell: pwsh
              run: Get-ChildItem -Path node_modules/node-pty/build/Release/ -ErrorAction SilentlyContinue

            - name: List built binaries (Unix)
              if: matrix.platform != 'win32'
              shell: bash
              run: ls -la node_modules/node-pty/build/Release/ || true

            # Prepare complete node-pty structure for upload (Windows)
            - name: Prepare node-pty bundle (Windows)
              if: matrix.platform == 'win32'
              shell: pwsh
              run: |
                  New-Item -ItemType Directory -Force -Path bundle/node-pty/build/Release
                  New-Item -ItemType Directory -Force -Path bundle/node-pty/lib

                  # Copy package.json
                  Copy-Item node_modules/node-pty/package.json bundle/node-pty/

                  # Copy JS files (lib directory)
                  Copy-Item -Recurse node_modules/node-pty/lib/* bundle/node-pty/lib/

                  # Copy native binaries (.node files)
                  Copy-Item node_modules/node-pty/build/Release/*.node bundle/node-pty/build/Release/

                  Write-Host "=== Bundle structure ==="
                  Get-ChildItem -Recurse bundle | Select-Object -First 20

            # Prepare complete node-pty structure for upload (Unix)
            - name: Prepare node-pty bundle (Unix)
              if: matrix.platform != 'win32'
              shell: bash
              run: |
                  mkdir -p bundle/node-pty/build/Release
                  mkdir -p bundle/node-pty/lib

                  # Copy package.json
                  cp node_modules/node-pty/package.json bundle/node-pty/

                  # Copy JS files (lib directory)
                  cp -r node_modules/node-pty/lib/* bundle/node-pty/lib/

                  # Copy native binaries (.node files)
                  cp node_modules/node-pty/build/Release/*.node bundle/node-pty/build/Release/

                  # Copy spawn-helper executable (required for macOS)
                  if [ -f "node_modules/node-pty/build/Release/spawn-helper" ]; then
                    cp node_modules/node-pty/build/Release/spawn-helper bundle/node-pty/build/Release/
                    chmod +x bundle/node-pty/build/Release/spawn-helper
                    echo "âœ… Copied spawn-helper for macOS"
                  fi

                  echo "=== Bundle structure ==="
                  find bundle -type f | head -20

            # Upload complete node-pty structure with ABI in artifact name
            - name: Upload native binaries
              uses: actions/upload-artifact@v4
              with:
                  name: native-${{ matrix.platform }}_${{ matrix.arch }}-abi${{ matrix.node-abi }}
                  path: bundle/node-pty
                  retention-days: 1

    # ===========================================
    # Build plugin and create release
    # ===========================================
    release:
        needs: build-native
        runs-on: ubuntu-latest
        name: Create Release

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            # Download all native artifacts for ABI 140 (Obsidian 1.11.x)
            - name: Download Windows x64 binaries (ABI 140)
              uses: actions/download-artifact@v4
              with:
                  name: native-win32_x64-abi140
                  path: native-bundle/abi140/win32_x64/node-pty

            - name: Download macOS x64 binaries (ABI 140)
              uses: actions/download-artifact@v4
              with:
                  name: native-darwin_x64-abi140
                  path: native-bundle/abi140/darwin_x64/node-pty

            - name: Download macOS arm64 binaries (ABI 140)
              uses: actions/download-artifact@v4
              with:
                  name: native-darwin_arm64-abi140
                  path: native-bundle/abi140/darwin_arm64/node-pty

            - name: Download Linux x64 binaries (ABI 140)
              uses: actions/download-artifact@v4
              with:
                  name: native-linux_x64-abi140
                  path: native-bundle/abi140/linux_x64/node-pty

            # Download all native artifacts for ABI 136 (Obsidian 1.10.x)
            - name: Download Windows x64 binaries (ABI 136)
              uses: actions/download-artifact@v4
              with:
                  name: native-win32_x64-abi136
                  path: native-bundle/abi136/win32_x64/node-pty

            - name: Download macOS x64 binaries (ABI 136)
              uses: actions/download-artifact@v4
              with:
                  name: native-darwin_x64-abi136
                  path: native-bundle/abi136/darwin_x64/node-pty

            - name: Download macOS arm64 binaries (ABI 136)
              uses: actions/download-artifact@v4
              with:
                  name: native-darwin_arm64-abi136
                  path: native-bundle/abi136/darwin_arm64/node-pty

            - name: Download Linux x64 binaries (ABI 136)
              uses: actions/download-artifact@v4
              with:
                  name: native-linux_x64-abi136
                  path: native-bundle/abi136/linux_x64/node-pty

            - name: List all downloaded files
              run: |
                  echo "=== Native bundle structure ==="
                  find native-bundle -type f | head -100

            # Build plugin
            - name: Build plugin
              run: pnpm run build

            # Get version from tag or manifest
            - name: Get version
              id: version
              run: |
                  if [ -n "${{ github.event.inputs.version }}" ]; then
                    VERSION="${{ github.event.inputs.version }}"
                  elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
                    VERSION="${GITHUB_REF#refs/tags/}"
                    VERSION="${VERSION#v}"  # Remove 'v' prefix if present
                  else
                    VERSION=$(node -p "require('./manifest.json').version")
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Version: $VERSION"

            # Create separate ZIPs for each platform x ABI combination
            - name: Create platform-specific ZIPs
              run: |
                  mkdir -p release-assets

                  # Create ZIPs for each ABI version
                  for abi_dir in native-bundle/*; do
                    abi_name=$(basename "$abi_dir")  # e.g., abi140, abi136

                    for platform_dir in "$abi_dir"/*; do
                      platform_name=$(basename "$platform_dir")  # e.g., win32_x64
                      zip_name="${{ env.PLUGIN_NAME }}-v${{ steps.version.outputs.version }}-native-${platform_name}-${abi_name}.zip"

                      echo "ðŸ“¦ Packaging $platform_name ($abi_name) into $zip_name..."

                      cd "$platform_dir"
                      zip -r "../../../release-assets/$zip_name" node-pty
                      cd - > /dev/null
                    done
                  done

                  echo "=== Generated Assets ==="
                  ls -la release-assets/

            # Prepare release directory
            - name: Prepare release files
              run: |
                  mkdir -p release
                  cp main.js release/
                  cp manifest.json release/
                  [ -f styles.css ] && cp styles.css release/ || touch release/styles.css

                  # Create Core Plugin ZIP (flat structure with main.js, manifest.json, styles.css)
                  cd release
                  zip "${{ env.PLUGIN_NAME }}-v${{ steps.version.outputs.version }}.zip" main.js manifest.json styles.css
                  cd ..

                  # Copy native platform zips to release folder
                  cp release-assets/*.zip release/
                  echo "=== Release files ==="
                  ls -la release/

            # Create GitHub Release
            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ steps.version.outputs.version }}
                  name: Release v${{ steps.version.outputs.version }}
                  draft: false
                  prerelease: false
                  generate_release_notes: true
                  files: |
                      release/main.js
                      release/manifest.json
                      release/styles.css
                      release/*.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ===========================================
    # Cleanup artifacts
    # ===========================================
    cleanup:
        needs: release
        runs-on: ubuntu-latest
        if: always()
        steps:
            - name: Delete artifacts
              uses: geekyeggo/delete-artifact@v4
              with:
                  name: |
                      native-win32_x64-abi140
                      native-darwin_x64-abi140
                      native-darwin_arm64-abi140
                      native-linux_x64-abi140
                      native-win32_x64-abi136
                      native-darwin_x64-abi136
                      native-darwin_arm64-abi136
                      native-linux_x64-abi136
